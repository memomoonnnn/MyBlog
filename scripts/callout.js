/**
 * scripts/obsidian-callout.js
 * 功能 1: 解析 Markdown 中的 Obsidian Callout 语法
 * 功能 2: 读取同目录下的 callout.css 并注入到页面头部
 */

const fs = require('fs');
const path = require('path');

console.log('>>> 正在加载 Callout 脚本... <<<'); // 【测试点 1】

// --- 功能 1: 注册 Markdown 解析过滤器 ---

hexo.extend.filter.register('before_post_render', function (data) {
	// 正则表达式匹配 Callout 块
	const calloutRegex = /^> ?\[!([a-zA-Z]+)\]([-+]?)(.*)\n((?:> ?.*\n?)*)/gm;

	// 检查是否有匹配
	if (calloutRegex.test(data.content)) {
		console.log('>>> 发现 Callout 语法，正在处理文章: ' + data.title); // 【测试点 2】
	}

	data.content = data.content.replace(calloutRegex, function (match, type, collapse, title, content) {

		// 元数据处理
		const calloutType = type.toLowerCase();
		const isCollapsible = collapse.length > 0;
		const isCollapsed = collapse === '-';
		const displayTitle = title.trim() || type.toUpperCase();

		// 图标映射 (Obsidian 风格 -> FontAwesome)
		const iconMap = {
			'abstract': 'fa-solid fa-clipboard-list',
			'info': 'fa-solid fa-circle-info',
			'note': 'fa-solid fa-pencil',
			'warning': 'fa-solid fa-triangle-exclamation',
			'tip': 'fa-solid fa-fire',
			'example': 'fa-solid fa-list',
			// 常用别名/扩展
			'todo': 'fa-solid fa-check',
			'question': 'fa-solid fa-circle-question',
			'quote': 'fa-solid fa-quote-left',
			'bug': 'fa-solid fa-bug',
			'error': 'fa-solid fa-circle-xmark',
			'success': 'fa-solid fa-circle-check',
			'fail': 'fa-solid fa-circle-xmark'
		};

		// 获取对应图标，默认为 pencil (note)
		const iconClass = iconMap[calloutType] || 'fa-solid fa-pencil';

		// 内容清洗与渲染
		const cleanContent = content.replace(/^> ?/gm, '');
		const renderedContent = hexo.render.renderSync({
			text: cleanContent,
			engine: 'markdown',
			gfm: true,
			breaks: true
		});

		// HTML 构建
		if (isCollapsible) {
			const openAttr = isCollapsed ? '' : 'open';
			return `
<details class="callout callout-${calloutType}" ${openAttr}>
    <summary class="callout-title">
        <span class="callout-icon"><i class="${iconClass}"></i></span>
        <span class="callout-text">${displayTitle}</span>
    </summary>
    <div class="callout-content">${renderedContent}</div>
</details>

`;
		} else {
			return `
<div class="callout callout-${calloutType}">
    <div class="callout-title">
        <span class="callout-icon"><i class="${iconClass}"></i></span>
        <span class="callout-text">${displayTitle}</span>
    </div>
    <div class="callout-content">${renderedContent}</div>
</div>

`;
		}
	});

	return data;
});

// --- 功能 2: 读取 CSS 文件并注入 ---

// 使用 Hexo 5.0+ 的 Injector API
hexo.extend.injector.register('head_end', () => {
	// 获取 CSS 文件的绝对路径
	// hexo.base_dir 是博客根目录
	const cssPath = path.join(hexo.base_dir, 'css_source', 'callout.css');

	try {
		// 同步读取文件内容
		const cssContent = fs.readFileSync(cssPath, 'utf8');
		// 返回带 <style> 标签的字符串
		return `<style>${cssContent}</style>`;
	} catch (e) {
		console.error('Hexo Callout Plugin Error: Could not read callout.css', e);
		return '';
	}
});